<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>To√°n 8 ‚Äì Nh√¢n ƒëa th·ª©c (Quiz)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
  :root{
    --pink:#ec4899; --purple:#a855f7;
    --green:#16a34a; --red:#ef4444; --gray:#9ca3af;
  }
  body{background:linear-gradient(135deg,#fdf2f8,#fae8ff);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .card{background:#fff;border-radius:1.25rem;box-shadow:0 10px 24px rgba(0,0,0,.12)}
  .btn{display:block;width:100%;padding:1rem 1.25rem;border-radius:1rem;border:1px solid #e5e7eb;font-weight:600;background:#fff;transition:.15s;text-align:left;font-size:1.125rem}
  .btn:hover{transform:scale(1.02);background:#fff0f6}
  .correct{background:var(--green)!important;color:#fff!important}
  .wrong{background:var(--red)!important;color:#fff!important}
  .disabled{pointer-events:none;opacity:.75}
  .explain{background:#fef9c3;color:#854d0e;border-radius:.75rem;padding:.75rem 1rem}
  .matchItem{padding:.6rem 1rem;border-radius:.6rem;border:1px solid #f9a8d4;background:#fde7f3;text-align:center;user-select:none}
  #matchCanvas{position:absolute;top:0;left:0;pointer-events:none}
  .step{width:2rem;height:2rem;border-radius:9999px;display:flex;align-items:center;justify-content:center;font-weight:700}
  .step-pending{background:#e5e7eb;color:#374151}
  .step-right{background:#bbf7d0;color:#065f46}
  .step-wrong{background:#fecaca;color:#7f1d1d}
  .step-locked{background:#f3f4f6;color:#6b7280;border:2px dashed #d1d5db}
</style>
</head>
<body class="min-h-screen flex flex-col items-center text-gray-800">

<!-- HOME -->
<section id="home" class="w-full max-w-2xl p-6">
  <div class="card p-8 text-center bg-gradient-to-br from-pink-50 to-purple-50">
    <h1 class="text-5xl font-extrabold bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent mb-2">üî• To√°n 8</h1>
    <p class="text-lg text-gray-600 mb-8">Chinh ph·ª•c ki·∫øn th·ª©c ‚Äì <b>Nh√¢n ƒëa th·ª©c</b></p>

    <div class="text-left grid gap-5">
      <div>
        <label class="font-semibold">üë§ T√™n ng∆∞·ªùi ch∆°i</label>
        <input id="playerName" class="w-full mt-1 rounded-xl border px-4 py-3 text-lg focus:ring-2 focus:ring-pink-400" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n"/>
      </div>
      <div class="grid grid-cols-2 gap-5">
        <div>
          <label class="font-semibold">üß© S·ªë c√¢u</label>
          <input id="numQ" type="number" min="5" max="20" value="8" class="w-full mt-1 rounded-xl border px-4 py-3 text-lg"/>
        </div>
        <div>
          <label class="font-semibold">‚è±Ô∏è Th·ªùi gian/c√¢u (gi√¢y)</label>
          <input id="secPerQ" type="number" min="10" max="120" value="30" class="w-full mt-1 rounded-xl border px-4 py-3 text-lg"/>
        </div>
      </div>
    </div>

    <button id="startBtn" class="mt-8 w-full rounded-2xl bg-gradient-to-r from-pink-500 to-purple-500 text-white text-2xl font-bold py-4 shadow hover:scale-105 transition">üöÄ B·∫Øt ƒë·∫ßu</button>
  </div>
</section>

<!-- QUIZ -->
<main id="quiz" class="hidden w-full max-w-5xl p-4 grid md:grid-cols-3 gap-6">
  <section class="md:col-span-2 card p-6 relative overflow-hidden">
    <canvas id="matchCanvas" class="hidden"></canvas>

    <!-- Thanh ti·∫øn tr√¨nh s·ªë -->
    <div id="steps" class="flex gap-2 flex-wrap mb-4"></div>

    <div class="flex items-center justify-between mb-3">
      <div>
        <div class="text-green-700 font-semibold">‚úÖ S·∫µn s√†ng!</div>
        <div id="qCounter" class="text-3xl font-extrabold">C√¢u 0/0</div>
      </div>
      <div class="w-56">
        <div class="text-sm text-gray-500 mb-1">‚è±Ô∏è Th·ªùi gian c√≤n</div>
        <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
          <div id="timeBar" class="h-full bg-pink-500" style="width:0%"></div>
        </div>
      </div>
    </div>

    <div id="questionBox" class="rounded-xl bg-pink-50 px-4 py-3 text-2xl font-bold min-h-[72px]"></div>
    <p id="hintBox" class="text-sm text-gray-500 mt-1 hidden"></p>

    <div id="optionsBox" class="mt-4 grid gap-3"></div>
    <div id="explainBox" class="hidden explain mt-4"></div>

    <div id="timeUpBox" class="hidden mt-4 text-red-600 font-semibold">‚õî H·∫øt th·ªùi gian. B·∫•m <b>C√¢u ti·∫øp</b> ƒë·ªÉ sang c√¢u kh√°c.</div>

    <div class="mt-6 flex gap-3">
      <button id="prevBtn" class="rounded-xl bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 font-semibold shadow">‚¨ÖÔ∏è C√¢u tr∆∞·ªõc</button>
      <button id="nextBtn" class="rounded-xl bg-pink-500 hover:bg-pink-600 text-white px-6 py-3 font-semibold shadow">C√¢u ti·∫øp ‚ñ∂</button>
    </div>
  </section>

  <aside class="card p-6">
    <h3 class="text-2xl font-extrabold text-pink-700 mb-2">üèÜ B·∫£ng ƒëi·ªÉm</h3>
    <ul class="space-y-1">
      <li>Ng∆∞·ªùi ch∆°i: <span id="hudName">‚Äî</span></li>
      <li>ƒêi·ªÉm: <span id="hudScore">0</span></li>
      <li>ƒê√∫ng/Sai: <span id="hudRightWrong">0 / 0</span></li>
      <li>‚è± <span id="hudTime">0</span>s / c√¢u</li>
    </ul>
  </aside>
</main>

<!-- RESULT -->
<section id="result" class="hidden w-full max-w-3xl p-6">
  <div class="card p-10 text-center">
    <h2 class="text-4xl font-extrabold text-pink-700 mb-2">üéâ Ho√†n th√†nh!</h2>
    <p class="text-2xl">ƒêi·ªÉm: <span id="rsScore"></span> / <span id="rsTotal"></span></p>
    <p class="text-lg text-gray-600 mt-1">ƒê√∫ng: <span id="rsRight"></span> ‚Ä¢ Sai: <span id="rsWrong"></span></p>
    <button id="againBtn" class="mt-6 rounded-xl bg-pink-500 hover:bg-pink-600 text-white text-xl font-semibold px-6 py-3">üîÅ Ch∆°i l·∫°i</button>
  </div>
</section>

<script>
const el = id => document.getElementById(id);

/* ===== Demo pool (ƒë·ªß 3 d·∫°ng) ===== */
const POOL = [
  {type:"mc", q:"T√≠nh (2x+3)(x+1)", a:"2x¬≤+5x+3", options:["2x¬≤+5x+3","2x¬≤+3x+1","x¬≤+2x+3"]},
  {type:"fill", q:"(x+2)(x+3)=x¬≤+__x+6", a:"5"},
  {type:"mc", q:"T√≠nh (x+4)(x+2)", a:"x¬≤+6x+8", options:["x¬≤+6x+8","x¬≤+4x+2","x¬≤+8x+4"]},
  {type:"match", q:"Gh√©p bi·ªÉu th·ª©c v·ªõi k·∫øt qu·∫£ ƒë√∫ng", pairs:[
    ["(x+1)¬≤","x¬≤+2x+1"],["(x+2)(x+3)","x¬≤+5x+6"],["(x-1)(x+4)","x¬≤+3x-4"]
  ]},
  {type:"fill", q:"(x+5)(x+1)=x¬≤+__x+5", a:"6"},
  {type:"mc", q:"T√≠nh (3x+2)(x+1)", a:"3x¬≤+5x+2", options:["3x¬≤+5x+2","3x¬≤+2x+1","x¬≤+3x+2"]},
  {type:"mc", q:"T√≠nh (x+3)(x+3)", a:"x¬≤+6x+9", options:["x¬≤+6x+9","x¬≤+3x+3","x¬≤+9x+6"]},
];

function shuffle(a){a=[...a];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function beep(f,t="sine",d=0.12){const ctx=new (window.AudioContext||window.webkitAudioContext)();const osc=ctx.createOscillator(),g=ctx.createGain();osc.type=t;osc.frequency.value=f;osc.connect(g);g.connect(ctx.destination);osc.start();setTimeout(()=>osc.stop(),d*1000);}
function sClick(){beep(600,"sine",0.06)}
function sRight(){beep(900,"triangle",0.12)}
function sWrong(){beep(200,"sawtooth",0.2)}
function confettiFx(){confetti({particleCount:70,spread:70,origin:{y:.85}})}

const STATE = {
  quiz:[], idx:0, nQuestions:8,
  player:"", duration:30, timeLeft:30, timer:null,
  score:0, right:0, wrong:0,
  perQ:[] // [{answered:false, correct:false, locked:false, data:{...}}]
};

function resetState(){
  STATE.idx=0; STATE.score=0; STATE.right=0; STATE.wrong=0;
  STATE.timeLeft=STATE.duration; STATE.timer=null; STATE.perQ=[];
}

function startGame(){
  STATE.player = el("playerName").value || "Kh√°ch";
  STATE.nQuestions = Math.min(parseInt(el("numQ").value||8), POOL.length);
  STATE.duration = parseInt(el("secPerQ").value||30);
  resetState();
  STATE.quiz = shuffle(POOL).slice(0, STATE.nQuestions);
  goQuiz();
  renderAllSteps();
  renderQuestion();
}

function goHome(){el("home").classList.remove("hidden");el("quiz").classList.add("hidden");el("result").classList.add("hidden");}
function goQuiz(){el("home").classList.add("hidden");el("quiz").classList.remove("hidden");el("result").classList.add("hidden");}
function goResult(){el("home").classList.add("hidden");el("quiz").classList.add("hidden");el("result").classList.remove("hidden");}

/* ===== Thanh ti·∫øn tr√¨nh 1‚Äìn ===== */
function renderAllSteps(){
  const c = el("steps"); c.innerHTML="";
  for(let i=0;i<STATE.nQuestions;i++){
    const s=document.createElement("div"); s.id="step-"+i; s.className="step step-pending"; s.textContent=i+1;
    c.appendChild(s);
  }
}
function colorStep(i,st){
  const d=el("step-"+i); if(!d) return;
  d.className="step "+(st.locked? "step-locked" : st.answered? (st.correct?"step-right":"step-wrong") : "step-pending");
}

/* ===== TIMER ===== */
function startTimerIfNeeded(){
  stopTimer();
  const st = ensureStatus(STATE.idx);
  el("timeUpBox").classList.add("hidden");
  if(st.answered || st.locked){updateTimeBar(0);return;}
  STATE.timeLeft = STATE.duration;
  updateTimeBar(STATE.timeLeft);
  STATE.timer = setInterval(()=>{
    STATE.timeLeft--;
    updateTimeBar(STATE.timeLeft);
    if(STATE.timeLeft<=0){
      stopTimer();
      st.locked=true; colorStep(STATE.idx, st);
      el("timeUpBox").classList.remove("hidden");
      disableInteractions(); el("nextBtn").disabled=false;
    }
  },1000);
}
function updateTimeBar(v){const pct = Math.max(0, Math.min(100, v/STATE.duration*100)); el("timeBar").style.width = pct+"%"; el("hudTime").textContent=STATE.duration;}
function stopTimer(){ if(STATE.timer){ clearInterval(STATE.timer); STATE.timer=null; } }

/* ===== STATUS ===== */
function ensureStatus(i){ if(!STATE.perQ[i]) STATE.perQ[i]={answered:false,correct:false,locked:false,data:{}}; return STATE.perQ[i]; }
function disableInteractions(){ [...el("optionsBox").querySelectorAll("button,input,.matchItem")].forEach(n=>n.classList.add("disabled")); }

/* ===== RENDER ===== */
function renderQuestion(){
  stopTimer(); sClick();
  const q = STATE.quiz[STATE.idx];
  const st = ensureStatus(STATE.idx);

  // HUD
  el("hudName").textContent = STATE.player;
  el("hudScore").textContent = STATE.score;
  el("hudRightWrong").textContent = `${STATE.right} / ${STATE.wrong}`;
  el("hudTime").textContent = STATE.duration;
  el("qCounter").textContent = `C√¢u ${STATE.idx+1}/${STATE.nQuestions}`;
  colorStep(STATE.idx, st);

  // C√¢u h·ªèi (ƒë·ªïi ‚ÄúT√≠nh ‚Ä¶‚Äù ‚áí ‚ÄúNh√¢n hai ƒëa th·ª©c ‚Ä¶‚Äù cho MCQ)
  let text = q.q || "";
  if(q.type==="mc") text = text.replace(/^T√≠nh\b/i,"Nh√¢n hai ƒëa th·ª©c");
  el("questionBox").innerHTML = text;

  // Hint cho k√©o-th·∫£
  el("hintBox").classList.add("hidden");
  if(q.type==="match"){
    el("hintBox").textContent = "H∆∞·ªõng d·∫´n: K√©o √¥ b√™n tr√°i sang √¥ b√™n ph·∫£i ƒë·ªÉ n·ªëi ƒë√∫ng. M·ªói c·∫∑p s·∫Ω c√≥ m·ªôt m√†u ri√™ng.";
    el("hintBox").classList.remove("hidden");
  }

  // reset v√πng hi·ªÉn th·ªã
  const box = el("optionsBox"); box.innerHTML="";
  el("explainBox").classList.add("hidden"); el("explainBox").innerHTML="";
  el("timeUpBox").classList.add("hidden");
  el("matchCanvas").classList.add("hidden");
  el("nextBtn").disabled = !(st.answered || st.locked);

  if(q.type==="mc"){
    const opts = (q.options||[]).filter(s=>s && s.trim() && s.trim()!=="‚Äî" && !s.includes("..."));
    shuffle(opts).forEach((opt,i)=>{
      const b=document.createElement("button");
      b.className="btn";
      b.innerHTML=`<span class="font-bold mr-2">${String.fromCharCode(65+i)}.</span> ${opt}`;
      b.onclick=()=>{
        if(st.answered || st.locked) return;
        st.answered = true;
        if(opt===q.a){ b.classList.add("correct"); sRight(); confettiFx(); STATE.score++; STATE.right++; st.correct=true; }
        else{ b.classList.add("wrong"); sWrong(); STATE.wrong++; st.correct=false; [...box.children].forEach(bb=>{ if(bb.textContent.includes(q.a)) bb.classList.add("correct"); }); }
        el("nextBtn").disabled = false; stopTimer(); updateHUD(); colorStep(STATE.idx, st);
      };
      if(st.answered || st.locked) b.classList.add("disabled");
      // highlight l·∫°i khi xem
      if(st.answered && opt===q.a) b.classList.add("correct");
      box.appendChild(b);
    });
  }

  if(q.type==="fill"){
    const input = document.createElement("input");
    input.id="blankInput"; input.placeholder="Nh·∫≠p ƒë√°p √°n...";
    input.className="w-full border rounded-xl px-4 py-2 text-xl";
    const btn = document.createElement("button");
    btn.id="submitBlank"; btn.className="mt-3 rounded-xl bg-pink-500 text-white px-4 py-2";
    btn.textContent="Tr·∫£ l·ªùi";
    box.appendChild(input); box.appendChild(btn);

    if(st.answered || st.locked){
      input.disabled = true; btn.disabled = true; el("nextBtn").disabled=false;
      if(st.data && st.data.ans!==undefined) input.value = st.data.ans;
      if(!st.correct){
        el("explainBox").innerHTML = `‚ùå Sai r·ªìi!<br>üìò Nh·ªõ c√¥ng th·ª©c (x+a)(x+b)=x¬≤+(a+b)x+ab<br>‚úÖ ƒê√°p √°n ƒë√∫ng: <b>${q.a}</b>`;
        el("explainBox").classList.remove("hidden");
      }
    }else{
      el("nextBtn").disabled = true;
      btn.onclick=()=>{
        const ans=input.value.trim();
        if(!ans){ alert("‚ö†Ô∏è B·∫°n c·∫ßn nh·∫≠p ƒë√°p √°n tr∆∞·ªõc khi n·ªôp!"); return; }
        st.answered = true; st.data.ans = ans; stopTimer();
        input.disabled = true; btn.disabled = true; el("nextBtn").disabled=false;
        if(ans===q.a){ sRight(); confettiFx(); STATE.score++; STATE.right++; st.correct=true; }
        else{ sWrong(); STATE.wrong++; st.correct=false;
          el("explainBox").innerHTML = `‚ùå Sai r·ªìi!<br>üìò Nh·ªõ c√¥ng th·ª©c (x+a)(x+b)=x¬≤+(a+b)x+ab<br>‚úÖ ƒê√°p √°n ƒë√∫ng: <b>${q.a}</b>`;
          el("explainBox").classList.remove("hidden");
        }
        updateHUD(); colorStep(STATE.idx, st);
      };
    }
  }

  if(q.type==="match"){ renderMatch(q, st); }

  startTimerIfNeeded();
}

function updateHUD(){
  el("hudScore").textContent = STATE.score;
  el("hudRightWrong").textContent = `${STATE.right} / ${STATE.wrong}`;
}

/* ===== MATCH (drag & drop v·ªõi d√¢y n·ªëi, m√†u c·∫∑p) ===== */
function renderMatch(q, st){
  const box = el("optionsBox");
  const area = document.createElement("div");
  area.className="relative";
  area.style.minHeight="320px";
  area.innerHTML=`
    <div class="grid grid-cols-2 gap-12 relative z-10">
      <div id="leftCol" class="space-y-6"></div>
      <div id="rightCol" class="space-y-6"></div>
    </div>`;
  box.appendChild(area);

  const L = elCreateList("leftCol", q.pairs.map((p,i)=>({id:`L${i}`,text:p[0]})));
  const R = elCreateList("rightCol", q.pairs.map((p,i)=>({id:`R${i}`,text:p[1]})));

  // canvas
  const canvas = el("matchCanvas");
  canvas.classList.remove("hidden");
  canvas.width = area.clientWidth;
  canvas.height = Math.max(area.clientHeight, 320);
  const ctx = canvas.getContext("2d");
  function redraw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    (st.data.matches||[]).forEach(m=>{
      const l = document.querySelector(`[data-id='${m.left}']`).getBoundingClientRect();
      const r = document.querySelector(`[data-id='${m.right}']`).getBoundingClientRect();
      const a = area.getBoundingClientRect();
      const x1=l.right-a.left, y1=l.top + l.height/2 - a.top;
      const x2=r.left - a.left, y2=r.top + r.height/2 - a.top;
      ctx.beginPath(); ctx.moveTo(x1,y1);
      ctx.bezierCurveTo(x1+80,y1,x2-80,y2,x2,y2);
      ctx.lineWidth=4; ctx.strokeStyle=m.color; ctx.stroke();
    });
  }
  function pairColor(){ return `hsl(${Math.random()*360},80%,60%)`; }

  if(!st.data.matches) st.data.matches=[];
  // Drag from left ‚Üí drop to right
  if(!(st.answered||st.locked)){
    L.forEach(elm=>{
      elm.draggable=true;
      elm.ondragstart=e=>{e.dataTransfer.setData("leftId",elm.dataset.id);}
    });
    R.forEach(elm=>{
      elm.ondragover=e=>e.preventDefault();
      elm.ondrop=e=>{
        const left=e.dataTransfer.getData("leftId"); if(!left) return;
        const right=elm.dataset.id;
        st.data.matches = st.data.matches.filter(m=>m.left!==left); // thay c·∫∑p n·∫øu ƒë√£ n·ªëi
        const color=pairColor();
        st.data.matches.push({left,right,color});
        document.querySelector(`[data-id='${left}']`).style.background=color+"33";
        elm.style.background=color+"33";
        redraw();
      };
    });
  }else{
    // view-only
    (st.data.matches||[]).forEach(m=>{
      const l=document.querySelector(`[data-id='${m.left}']`);
      const r=document.querySelector(`[data-id='${m.right}']`);
      if(l) l.style.background=(m.color||"#ddd")+"33";
      if(r) r.style.background=(m.color||"#ddd")+"33";
    });
    redraw();
  }

  // N√∫t n·ªôp & ch·∫•m
  const submit=document.createElement("button");
  submit.className="mt-4 rounded-xl bg-pink-500 text-white px-4 py-2";
  submit.textContent="N·ªôp k·∫øt qu·∫£";
  box.appendChild(submit);

  if(st.answered || st.locked){ submit.classList.add("disabled"); el("nextBtn").disabled=false; }
  else{
    el("nextBtn").disabled=true;
    submit.onclick=()=>{
      st.answered=true; stopTimer(); el("nextBtn").disabled=false;
      // ch·∫•m
      st.data.matches.forEach(m=>{
        const idx=m.left.slice(1), correct=`R${idx}`;
        const l=document.querySelector(`[data-id='${m.left}']`);
        const r=document.querySelector(`[data-id='${m.right}']`);
        if(m.right===correct){ m.color="green"; l.style.background="#86efac"; r.style.background="#86efac"; STATE.score++; STATE.right++; }
        else{ m.color="red"; l.style.background="#fca5a5"; r.style.background="#fca5a5"; STATE.wrong++; }
      });
      redraw(); sRight(); confettiFx(); updateHUD(); colorStep(STATE.idx, st);
    };
  }

  function elCreateList(colId, items){
    const col = document.getElementById(colId);
    return items.map(it=>{
      const d=document.createElement("div");
      d.className="matchItem"; d.dataset.id=it.id; d.textContent=it.text; col.appendChild(d); return d;
    });
  }
}

/* ===== NAV ===== */
el("nextBtn").onclick=()=>{
  if(STATE.idx<STATE.nQuestions-1){ STATE.idx++; renderQuestion(); }
  else finishGame();
};
el("prevBtn").onclick=()=>{
  if(STATE.idx>0){ STATE.idx--; renderQuestion(); } // xem l·∫°i; kh√¥ng cho l√†m l·∫°i v√¨ ƒë√£ kh√≥a/answered
};

function finishGame(){
  stopTimer();
  el("rsScore").textContent=STATE.score;
  el("rsTotal").textContent=STATE.nQuestions;
  el("rsRight").textContent=STATE.right;
  el("rsWrong").textContent=STATE.wrong;
  goResult();
}

/* ===== HOOKS ===== */
el("startBtn").onclick=startGame;
el("againBtn").onclick=()=>{ goHome(); };

/* ===== INIT ===== */
goHome();
</script>
</body>
</html>
