document.addEventListener("DOMContentLoaded", () => {
  // ==== DOM ====
  const clsSel = document.getElementById("cls");
  const studentTop = document.getElementById("studentTop");
  const btnCall = document.getElementById("btnCall");
  const overlay = document.getElementById("overlay");
  const bigName = document.getElementById("bigName");

  const btnShuffle = document.getElementById("btnShuffle");
  const btnStart = document.getElementById("btnStart");
  const btnConfirm = document.getElementById("btnConfirm");
  const btnNext = document.getElementById("btnNext");
  const btnEnd = document.getElementById("btnEnd");
  const btnReplay = document.getElementById("btnReplay");

  const lessonWrap = document.getElementById("lessonWrap");
  const qtext = document.getElementById("qtext");
  const opts = document.getElementById("opts");
  const prog = document.getElementById("prog");
  const card = document.getElementById("card");
  const hint = document.getElementById("hint");
  const toastBox = document.getElementById("toast");
  const fx = document.getElementById("fx");
  const bigTimer = document.getElementById("bigTimer");

  // ==== State ====
  let currentStudents = [];
  let currentStudent = null;
  let hasStudent = false;
  let hasLesson = false;

  // lessons người dùng tick: C1_B1 … C5_B5
  const selectedLessons = new Set();

  // pool câu hỏi đã nạp & xáo
  let pool = [];
  let qIndex = 0;
  let score = 0;
  let timer = null;
  let timePerQ = 60;
  let numQ = 10;

  // ==== Utils ====
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const showToast = (m) => {
    toastBox.textContent = m;
    toastBox.style.display = "block";
    setTimeout(() => (toastBox.style.display = "none"), 1800);
  };
  const enable = (el, on = true) => (el.disabled = !on);

  function updateStartButton() {
    btnStart.disabled = !(hasStudent && hasLesson);
  }

  // ====== LOAD FILES THEO QUY ƯỚC ======
  // students_8a5.json, students_8a1.json, ...
  async function loadStudentsByClass(lop) {
    const file = `assets/data/students_${lop.toLowerCase()}.json`;
    try {
      const r = await fetch(file);
      if (!r.ok) throw new Error("not found");
      const data = await r.json();
      return Array.isArray(data) ? data : (data.students || []);
    } catch (e) {
      console.error(e);
      showToast("Không tải được danh sách HS!");
      return [];
    }
  }

  // questions_b1.json … questions_b5.json
  async function loadQuestionsByBai(b) {
    const file = `assets/data/questions_b${b}.json`;
    try {
      const r = await fetch(file);
      if (!r.ok) throw new Error("not found");
      const data = await r.json();
      return Array.isArray(data) ? data : (data.questions || []);
    } catch (e) {
      console.error(e);
      showToast(`Không tải được câu hỏi Bài ${b}!`);
      return [];
    }
  }

  // gom tất cả bài được chọn → tập hợp unique theo số bài 1..5
  async function buildPoolFromSelected() {
    const baiSet = new Set(
      [...selectedLessons].map((key) => parseInt(key.split("_B")[1], 10))
    );
    const loaders = [...baiSet].map((b) => loadQuestionsByBai(b));
    const lists = await Promise.all(loaders);
    let merged = [];
    lists.forEach((arr) => (merged = merged.concat(arr)));
    // xáo
    for (let i = merged.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [merged[i], merged[j]] = [merged[j], merged[i]];
    }
    return merged;
  }

  // ==== UI: render lessons (Ch I–V × Bài 1–5) ====
  function renderLessons() {
    const roman = ["I", "II", "III", "IV", "V"];
    lessonWrap.innerHTML = "";
    for (let c = 1; c <= 5; c++) {
      // mỗi chapter 1 hàng "Chương X | B1 B2 B3 B4 B5"
      const row = document.createElement("div");
      row.style.display = "grid";
      row.style.gridTemplateColumns = "140px repeat(5, 1fr)";
      row.style.gap = "6px";
      row.style.alignItems = "center";
      row.style.margin = "4px 0";

      const left = document.createElement("div");
      left.textContent = `Chương ${roman[c - 1]}`;
      left.style.fontWeight = "900";
      row.appendChild(left);

      for (let b = 1; b <= 5; b++) {
        const key = `C${c}_B${b}`;
        const label = document.createElement("label");
        label.className = "pill";
        label.style.userSelect = "none";
        label.style.display = "inline-block";
        label.style.textAlign = "center";
        label.textContent = `Bài ${b}`;
        label.onclick = () => {
          if (selectedLessons.has(key)) {
            selectedLessons.delete(key);
            label.classList.remove("active");
          } else {
            selectedLessons.add(key);
            label.classList.add("active");
          }
          hasLesson = selectedLessons.size > 0;
          enable(btnShuffle, hasLesson);
          updateStartButton();
        };
        row.appendChild(label);
      }
      lessonWrap.appendChild(row);
    }
  }

  // ==== Clock ====
  setInterval(() => {
    document.getElementById("clock").textContent = new Date()
      .toLocaleTimeString("vi-VN")
      .slice(0, 8);
  }, 1000);

  // ==== Timer ====
  function startTimer(sec) {
    clearInterval(timer);
    let t = sec;
    bigTimer.textContent = String(t).padStart(2, "0");
    timer = setInterval(() => {
      t--;
      bigTimer.textContent = String(t).padStart(2, "0");
      if (t <= 0) {
        clearInterval(timer);
        autoRevealThenNext();
      }
    }, 1000);
  }

  function autoRevealThenNext() {
    // highlight đáp án đúng
    const ans = pool[qIndex]?.a ?? pool[qIndex]?.answer;
    document.querySelectorAll(".opt").forEach((o) => {
      if (o.textContent.trim() === String(ans)) o.classList.add("correct");
    });
    btnConfirm.classList.add("hide");
    btnNext.classList.remove("hide");
    showToast("Hết giờ!");
  }

  // ==== Render 1 câu ====
  function renderQuestion() {
    if (qIndex >= pool.length) {
      endGame();
      return;
    }
    const q = pool[qIndex];
    qtext.innerHTML = q.q || q.question || "—";
    if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();

    opts.innerHTML = "";
    const options = (q.options || q.choices || []).slice(0, 4);
    options.forEach((t) => {
      const div = document.createElement("div");
      div.className = "opt";
      div.textContent = t;
      div.onclick = () => {
        document.querySelectorAll(".opt").forEach((x) => x.classList.remove("selected"));
        div.classList.add("selected");
      };
      opts.appendChild(div);
    });

    prog.textContent = `Câu ${qIndex + 1}/${pool.length} — Điểm: ${score}`;
    btnConfirm.classList.remove("hide");
    btnNext.classList.add("hide");
    startTimer(timePerQ);
  }

  function lockOptions() {
    document.querySelectorAll(".opt").forEach((o) => (o.onclick = null));
  }

  function endGame() {
    clearInterval(timer);
    qtext.innerHTML = `<b>Kết thúc!</b> Bạn được ${score}/${pool.length} điểm.`;
    opts.innerHTML = "";
    btnConfirm.classList.add("hide");
    btnNext.classList.add("hide");
    btnReplay.classList.remove("hide");
    card.classList.remove("hide");
    hint.classList.add("hide");
  }

  // ====== Sự kiện ======
  // Tạo danh sách lớp 8A1 → 8A7
  ["8A1","8A2","8A3","8A4","8A5","8A6","8A7"].forEach((name)=>{
    const o=document.createElement("option"); o.value=name; o.textContent=name; clsSel.appendChild(o);
  });

  // Gọi tên HS (random 4s → dừng 3s)
  btnCall.onclick = async () => {
    if (!clsSel.value) {
      showToast("Chọn lớp trước");
      return;
    }
    currentStudents = await loadStudentsByClass(clsSel.value);
    if (!currentStudents.length) {
      showToast("Không có danh sách HS");
      return;
    }

    overlay.classList.remove("hide");
    let t = 0;
    const spin = setInterval(() => {
      bigName.textContent =
        currentStudents[Math.floor(Math.random() * currentStudents.length)];
      t += 100;
      if (t >= 4000) {
        clearInterval(spin);
        currentStudent =
          currentStudents[Math.floor(Math.random() * currentStudents.length)];
        bigName.textContent = currentStudent;
        setTimeout(() => {
          overlay.classList.add("hide");
          studentTop.textContent = currentStudent;
          hasStudent = true;
          updateStartButton();
        }, 3000);
      }
    }, 100);
  };

  // Trộn câu (xáo với animation 3s + load đúng file theo bài)
  btnShuffle.onclick = async () => {
    if (!hasLesson) return;
    fx.classList.remove("hide");
    fx.textContent = "ĐANG TRỘN...";
    // nạp & xáo trước để Start vào là có ngay
    pool = await buildPoolFromSelected();
    setTimeout(() => {
      fx.classList.add("hide");
      showToast(`Đã trộn ${pool.length} câu!`);
    }, 3000);
  };

  // Bắt đầu
  btnStart.onclick = async () => {
    if (!(hasStudent && hasLesson)) {
      showToast("Hãy Gọi tên HS & chọn Bài");
      return;
    }
    timePerQ = clamp(parseInt(document.getElementById("time").value || "60", 10), 10, 180);
    numQ = clamp(parseInt(document.getElementById("num").value || "10", 10), 1, 100);

    // nếu chưa trộn trước đó, nạp & xáo ngay
    if (!pool.length) pool = await buildPoolFromSelected();

    // cắt theo số câu
    pool = pool.slice(0, Math.min(numQ, pool.length));
    qIndex = 0;
    score = 0;

    // khóa các nút cấu hình khi đang làm
    enable(btnCall, false);
    enable(btnShuffle, false);

    hint.classList.add("hide");
    card.classList.remove("hide");
    renderQuestion();
  };

  // Xác nhận
  btnConfirm.onclick = () => {
    const sel = document.querySelector(".opt.selected");
    if (!sel) {
      showToast("Chọn đáp án!");
      return;
    }
    clearInterval(timer);
    const ans = String(pool[qIndex].a || pool[qIndex].answer);
    if (sel.textContent.trim() === ans) {
      sel.classList.add("correct");
      score++;
    } else {
      sel.classList.add("incorrect");
      document.querySelectorAll(".opt").forEach((o) => {
        if (o.textContent.trim() === ans) o.classList.add("correct");
      });
    }
    lockOptions();
    btnConfirm.classList.add("hide");
    btnNext.classList.remove("hide");
    prog.textContent = `Câu ${qIndex + 1}/${pool.length} — Điểm: ${score}`;
  };

  // Câu tiếp
  btnNext.onclick = () => {
    qIndex++;
    renderQuestion();
  };

  // Kết thúc
  btnEnd.onclick = () => endGame();

  // Chơi lại (reset nhẹ: giữ UI, reset trạng thái)
  btnReplay.onclick = () => {
    btnReplay.classList.add("hide");
    card.classList.add("hide");
    hint.classList.remove("hide");
    // mở lại các nút cấu hình
    enable(btnCall, true);
    enable(btnShuffle, hasLesson);
    showToast("Đã sẵn sàng chơi lại");
  };

  // Render lesson grid khi load
  renderLessons();
});
