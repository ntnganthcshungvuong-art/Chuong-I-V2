<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ğŸ”¥ Quiz ToÃ¡n 8 - ChÆ°Æ¡ng I ğŸ”¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; }
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gradient-to-r from-yellow-100 to-green-200 min-h-screen flex flex-col items-center p-6">

  <h1 class="text-3xl font-bold mb-6">ğŸ”¥ Quiz ToÃ¡n 8 - ChÆ°Æ¡ng I ğŸ”¥</h1>

  <div id="menuScreen" class="text-center">
    <p class="mb-4 text-gray-700">Chá»n cháº¿ Ä‘á»™ chÆ¡i:</p>
    <div class="flex gap-6 justify-center">
      <button id="btnSingle" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl shadow-lg">ğŸ¯ ChÆ¡i Ä‘Æ¡n</button>
      <button id="btnVersus" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl shadow-lg">âš”ï¸ Äá»‘i khÃ¡ng 2 cá»­a</button>
    </div>
  </div>

  <div id="quizSingle" class="hidden w-full max-w-2xl mt-6">
    <h2 class="text-xl font-bold text-center text-green-700">ğŸ¯ Cháº¿ Ä‘á»™ chÆ¡i Ä‘Æ¡n</h2>
    <p id="counterSingle" class="font-semibold">CÃ¢u 1/10</p>
    <div id="qBoxSingle" class="bg-white p-4 rounded-xl shadow mb-3 text-lg font-medium"></div>
    <div id="optsSingle" class="grid gap-2"></div>
    <button onclick="nextQ('single')" id="nextBtnSingle" class="hidden mt-3 bg-green-500 text-white px-4 py-2 rounded-lg">CÃ¢u tiáº¿p</button>
  </div>

  <div id="versusArea" class="hidden w-full grid grid-cols-2 gap-6 mt-6">
    <div class="border-2 border-red-400 rounded-xl p-4 bg-white">
      <h2 class="text-xl font-bold text-red-600">ğŸ”‘ Cá»­a 1</h2>
      <p id="counter1" class="font-semibold">CÃ¢u 1/10</p>
      <div id="qBox1" class="bg-gray-50 p-3 rounded-lg mb-2"></div>
      <div id="opts1" class="grid gap-2"></div>
      <button onclick="nextQ(1)" id="nextBtn1" class="hidden mt-2 bg-green-500 text-white px-4 py-2 rounded-lg">CÃ¢u tiáº¿p</button>
    </div>
    <div class="border-2 border-blue-400 rounded-xl p-4 bg-white">
      <h2 class="text-xl font-bold text-blue-600">ğŸ”‘ Cá»­a 2</h2>
      <p id="counter2" class="font-semibold">CÃ¢u 1/10</p>
      <div id="qBox2" class="bg-gray-50 p-3 rounded-lg mb-2"></div>
      <div id="opts2" class="grid gap-2"></div>
      <button onclick="nextQ(2)" id="nextBtn2" class="hidden mt-2 bg-green-500 text-white px-4 py-2 rounded-lg">CÃ¢u tiáº¿p</button>
    </div>
  </div>

  <div id="scoreBoard" class="hidden mt-6 bg-white shadow-lg rounded-xl p-4">
    <p class="text-lg font-bold">ğŸ† Báº£ng Ä‘iá»ƒm</p>
    <p>Cá»­a 1: <span id="score1">0</span></p>
    <p>Cá»­a 2: <span id="score2">0</span></p>
    <p>ChÆ¡i Ä‘Æ¡n: <span id="scoreSingle">0</span></p>
  </div>

  <audio id="soundCorrect" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"></audio>
  <audio id="soundWrong" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-buzz-950.mp3"></audio>
  <audio id="soundWin" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
  <audio id="soundLose" src="https://assets.mixkit.co/sfx/preview/mixkit-game-over-fail-2014.mp3"></audio>

<script>
let dataAll = {}, quizSingle=[], quizData1=[], quizData2=[];
let idxSingle=0, idx1=0, idx2=0;
let scoreSingle=0, score1=0, score2=0;

async function loadData(){
  try {
    if(Object.keys(dataAll).length===0){
      const res = await fetch("./questions.json?_=" + Date.now());
      if(!res.ok) throw new Error("HTTP error " + res.status);
      dataAll = await res.json();
      console.log("ğŸ¯ questions.json loaded, tá»•ng cÃ¢u há»i:", 
        (dataAll.Bai1||[]).length + (dataAll.Bai2||[]).length + (dataAll.Bai3||[]).length + (dataAll.Bai4||[]).length
      );
    }
  } catch (err){
    console.error("âŒ fetch error:", err);
    alert("âŒ Lá»—i khi táº£i dá»¯ liá»‡u: " + err.message);
  }
}

async function startGame(mode){
  console.log("Clicked mode:", mode);
  await loadData();
  const allQs = [...(dataAll.Bai1||[]), ...(dataAll.Bai2||[]), ...(dataAll.Bai3||[]), ...(dataAll.Bai4||[])];
  if(allQs.length === 0){
    alert("âš ï¸ KhÃ´ng cÃ³ cÃ¢u há»i nÃ o Ä‘á»ƒ chÆ¡i!");
    return;
  }
  document.getElementById('menuScreen').classList.add('hidden');
  document.getElementById('scoreBoard').classList.remove('hidden');

  if(mode === 'single'){
    quizSingle = pick(allQs,10);
    idxSingle = 0; scoreSingle = 0;
    document.getElementById('quizSingle').classList.remove('hidden');
    showQ('single');
  } else {
    quizData1 = pick(allQs,10);
    quizData2 = pick(allQs,10);
    idx1 = 0; idx2 = 0; score1 = 0; score2 = 0;
    document.getElementById('versusArea').classList.remove('hidden');
    showQ(1); showQ(2);
  }
}

window.onload = function(){
  document.getElementById('btnSingle').onclick = () => startGame('single');
  document.getElementById('btnVersus').onclick = () => startGame('versus');
};

function showQ(mode){
  if(mode === 'single'){
    let q = quizSingle[idxSingle];
    document.getElementById('counterSingle').innerText = `CÃ¢u ${idxSingle+1}/10`;
    document.getElementById('qBoxSingle').innerHTML = `<span class="text-xl font-bold">${cleanQ(q.q)}</span>`;
    let html = '';
    shuffle(q.options).forEach(opt => {
      html += `<button onclick="answer('single',this,'${q.a}')" class="bg-white border p-2 rounded-lg hover:bg-yellow-100 text-lg">${opt}</button>`;
    });
    document.getElementById('optsSingle').innerHTML = html;
    document.getElementById('nextBtnSingle').classList.add('hidden');
  } else {
    let idx = (mode === 1 ? idx1 : idx2);
    let q = (mode === 1 ? quizData1[idx] : quizData2[idx]);
    document.getElementById('counter'+mode).innerText = `CÃ¢u ${idx+1}/10`;
    document.getElementById('qBox'+mode).innerHTML = `<span class="text-lg font-bold">${cleanQ(q.q)}</span>`;
    let html = '';
    shuffle(q.options).forEach(opt => {
      html += `<button onclick="answer(${mode},this,'${q.a}')" class="bg-white border p-2 rounded-lg hover:bg-yellow-100 text-lg">${opt}</button>`;
    });
    document.getElementById('opts'+mode).innerHTML = html;
    document.getElementById('nextBtn'+mode).classList.add('hidden');
  }
}

function answer(mode,btn,correct){
  let chosen = btn.innerText.trim();
  let buttons = (mode === 'single' ? document.querySelectorAll('#optsSingle button') : document.querySelectorAll('#opts'+mode+' button'));
  buttons.forEach(b => b.disabled = true);
  if(chosen === correct){
    btn.classList.add('bg-green-300');
    playSound("soundCorrect");
    if(mode === 'single'){ scoreSingle += 10; updateScore(); }
    else if(mode === 1){ score1 += 10; updateScore(); }
    else{ score2 += 10; updateScore(); }
  } else {
    btn.classList.add('bg-red-300');
    playSound("soundWrong");
    buttons.forEach(b => {
      if(b.innerText.trim() === correct){
        b.classList.add('ring-2','ring-green-600');
      }
    });
  }
  if(mode === 'single') document.getElementById('nextBtnSingle').classList.remove('hidden');
  else document.getElementById('nextBtn'+mode).classList.remove('hidden');
}

function nextQ(mode){
  if(mode === 'single'){
    idxSingle++;
    if(idxSingle < quizSingle.length){
      showQ('single');
    } else {
      endGame('single');
    }
  } else if(mode === 1){
    idx1++;
    if(idx1 < quizData1.length){
      showQ(1);
    } else {
      endGame('versus');
    }
  } else {
    idx2++;
    if(idx2 < quizData2.length){
      showQ(2);
    } else {
      endGame('versus');
    }
  }
}

function endGame(mode){
  if(mode === 'single'){
    playSound("soundWin");
    alert(`ğŸ‰ HoÃ n thÃ nh!\nÄiá»ƒm: ${scoreSingle}`);
    location.reload();
  } else if(idx1 >= 10 && idx2 >= 10){
    let msg = `ğŸ‰ Tráº­n Ä‘áº¥u káº¿t thÃºc!\nCá»­a 1: ${score1} Ä‘iá»ƒm\nCá»­a 2: ${score2} Ä‘iá»ƒm\n`;
    if(score1 > score2){
      msg += "ğŸ‘‰ Cá»­a 1 Tháº¯ng!";
      playSound("soundWin");
    } else if(score2 > score1){
      msg += "ğŸ‘‰ Cá»­a 2 Tháº¯ng!";
      playSound("soundWin");
    } else {
      msg += "ğŸ¤ HÃ²a!";
      playSound("soundLose");
    }
    alert(msg);
    location.reload();
  }
}

function updateScore(){
  document.getElementById('score1').innerText = score1;
  document.getElementById('score2').innerText = score2;
  document.getElementById('scoreSingle').innerText = scoreSingle;
}

function cleanQ(text){
  return text.replace(/^CÃ¢u\s*\d+:\s*/,'');
}

function playSound(id){
  const audio = document.getElementById(id);
  if(audio){
    audio.currentTime = 0;
    audio.play().catch(err => console.log("Ã‚m thanh bá»‹ cháº·n:", err));
  }
}

function pick(arr,n){
  let out = [];
  for(let i=0; i<n; i++){
    out.push(arr[Math.floor(Math.random()*arr.length)]);
  }
  return out;
}

function shuffle(arr){
  for(let i=arr.length-1; i>0; i--){
    let j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
</script>

</body>
</html>
